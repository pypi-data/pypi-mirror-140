{"version":3,"sources":["abstractCommentBlockModel.es6.js"],"names":[],"mappings":"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","file":"abstractCommentBlockModel.js","sourcesContent":["/**\n * Represents a region of reviewable content that contains comments.\n *\n * This stores all comments that match a given region, as defined by a\n * subclass of AbstractCommentBlock.\n *\n * New draft comments can be created, which will later be stored on the\n * server.\n *\n * The total number of comments in the block (including any draft comment)\n * will be stored, which may be useful for display.\n *\n * Model Attributes:\n *     canDelete (boolean):\n *         Whether or not the comment can be deleted.\n *\n *     count (number):\n *         The total number of comments, including a draft comment.\n *\n *     draftComment (RB.BaseComment):\n *         The draft comment that this block is associated with.\n *\n *     hasDraft (boolean):\n *         Whether or not the review request has a draft.\n *\n *     review (RB.Review):\n *         The review that the associated comment is a part of.\n *\n *     reviewRequest (RB.ReviewRequest):\n *         The review request that this comment is on.\n *\n *     serializedComments (Array of object):\n *         An array of serialized comments for display.\n */\nRB.AbstractCommentBlock = Backbone.Model.extend({\n    defaults: {\n        hasDraft: false,\n        canDelete: false,\n        draftComment: null,\n        reviewRequest: null,\n        review: null,\n        serializedComments: [],\n        count: 0\n    },\n\n    /**\n     * Initialize the AbstractCommentBlock.\n     */\n    initialize() {\n        console.assert(this.get('reviewRequest'),\n                       'reviewRequest must be provided');\n        console.assert(this.get('review'),\n                       'review must be provided');\n\n        /*\n         * Find out if there are any draft comments and filter them out of the\n         * stored list of comments.\n         */\n        const comments = this.get('serializedComments');\n        const newSerializedComments = [];\n\n        if (comments.length > 0) {\n            comments.forEach(comment => {\n                // We load in encoded text, so decode it.\n                comment.text = $('<div>').html(comment.text).text();\n\n                if (comment.localdraft) {\n                    this.ensureDraftComment(comment.comment_id, {\n                        text: comment.text,\n                        richText: comment.rich_text,\n                        issueOpened: comment.issue_opened,\n                        issueStatus: comment.issue_status,\n                        html: comment.html,\n                    });\n                } else {\n                    newSerializedComments.push(comment);\n                }\n            }, this);\n\n            this.set('serializedComments', newSerializedComments);\n        } else {\n            this.ensureDraftComment();\n        }\n\n        this.on('change:draftComment', this._updateCount, this);\n        this._updateCount();\n    },\n\n    /**\n     * Return whether or not the comment block is empty.\n     *\n     * A comment block is empty if there are no stored comments and no\n     * draft comment.\n     *\n     * Returns:\n     *     boolean:\n     *     Whether the comment block is empty.\n     */\n    isEmpty() {\n        return (this.get('serializedComments').length === 0 &&\n                !this.has('draftComment'));\n    },\n\n    /**\n     * Create a draft comment, optionally with a given ID and text.\n     *\n     * This must be implemented by a subclass to return a Comment class\n     * specific to the subclass.\n     *\n     * Args:\n     *     id (number):\n     *         The ID of the comment to instantiate the model for.\n     *\n     * Returns:\n     *     RB.BaseComment:\n     *     The new comment model.\n     */\n    createComment(id) {\n        console.assert(false, 'This must be implemented by a subclass');\n    },\n\n    /**\n     * Create a draft comment in this comment block.\n     *\n     * Only one draft comment can exist per block, so if one already exists,\n     * this will do nothing.\n     *\n     * The actual comment object is up to the subclass to create.\n     *\n     * Args:\n     *     id (number):\n     *         The ID of the comment.\n     *\n     *     comment_attr (object):\n     *         Attributes to set on the comment model.\n     */\n    ensureDraftComment(id, comment_attr) {\n        if (this.has('draftComment')) {\n            return;\n        }\n\n        const comment = this.createComment(id);\n        comment.set(comment_attr);\n        comment.on('saved', this._updateCount, this);\n        comment.on('destroy', () => {\n            this.set('draftComment', null);\n            this._updateCount();\n        });\n\n        this.set('draftComment', comment);\n    },\n\n    /**\n     * Update the displayed number of comments in the comment block.\n     *\n     * If there's a draft comment, it will be added to the count. Otherwise,\n     * this depends solely on the number of published comments.\n     */\n    _updateCount() {\n        let count = this.get('serializedComments').length;\n\n        if (this.has('draftComment')) {\n            count++;\n        }\n\n        this.set('count', count);\n    },\n});\n"]}