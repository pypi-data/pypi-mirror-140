{"version":3,"sources":["infoboxManagerView.es6.js"],"names":[],"mappings":"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","file":"infoboxManagerView.js","sourcesContent":["/**\n * Manages the registration, display, and interaction of infoboxes.\n *\n * This view is responsible for tracking the various forms of infoboxes needed\n * on a page and handling their display when hovering over a target. It can\n * also create jQuery functions for registering elements with particular\n * infoboxes.\n *\n * There's only one instance used per page, accessed via\n * :js:func:`RB.InfoboxManagerView.getInstance`.\n */\nRB.InfoboxManagerView = Backbone.View.extend({\n    /** The delay after hovering over a target before displaying an infobox. */\n    POPUP_DELAY_MS: 700,\n\n    /** The delay after leaving a target before hiding an infobox. */\n    HIDE_DELAY_MS: 400,\n\n    /** The animation time for fading in an infobox. */\n    FADE_IN_MS: 200,\n\n    /** The animation time for fading out an infobox. */\n    FADE_OUT_MS: 150,\n\n    /**\n     * Initialize the manager.\n     */\n    initialize() {\n        this._infoboxViews = {};\n        this._activeInfoboxView = null;\n        this._cache = {};\n        this._showTimeout = null;\n        this._hideTimeout = null;\n    },\n\n    /**\n     * Remove the manager's infoboxes from the DOM.\n     */\n    remove() {\n        Backbone.View.prototype.remove.call(this);\n\n        for (let key in this._infoboxViews) {\n            if (this._infoboxViews.hasOwnProperty(key)) {\n                this._infoboxViews[key].remove();\n            }\n        }\n\n        this._infoboxViews = {};\n        this._cache = {};\n        this._activeInfoboxView = null;\n    },\n\n    /**\n     * Add one or more targets for a particular type of infobox.\n     *\n     * These targets will trigger the specified infobox when hovering over\n     * them.\n     *\n     * Args:\n     *     infoboxViewType (prototype):\n     *         The type of infobox to register with. This must be a subclass\n     *         of :js:class:`RB.BaseInfoboxView`.\n     *\n     *     $targets (jQuery):\n     *         A set of jQuery targets to register with the infobox.\n     */\n    addTargets(infoboxViewType, $targets) {\n        $targets.each((idx, target) => {\n            const $target = $(target);\n\n            if (!$target.data('has-infobox')) {\n                /*\n                 * Note that we're wanting to bind the functions instead of\n                 * using fat arrow functions in order to avoid having two\n                 * new anonymous functions per target, which is wasteful and\n                 * unnecessary.\n                 */\n                $target\n                    .data('has-infobox', true)\n                    .on('mouseenter',\n                        this._onTargetMouseEnter.bind(this, $target,\n                                                      infoboxViewType))\n                    .on('mouseleave', this._onMouseLeave.bind(this));\n            }\n        });\n    },\n\n    /**\n     * Set the positioning for a particular type of infobox.\n     *\n     * This is used to control how an infobox would be positioned on the\n     * page, relative to the target element. It completely overrides the\n     * default positioning for that type of infobox.\n     *\n     * Args:\n     *     infoboxViewType (prototype):\n     *         The type of infobox to alter the position for.\n     *\n     *     positioning (object):\n     *         The positioning information. This must be a value compatible\n     *         with :js:func:`$.fn.positionToSide`.\n     */\n    setPositioning(infoboxViewType, positioning) {\n        this.getOrCreateInfobox(infoboxViewType).positioning = positioning;\n    },\n\n    /**\n     * Return an instance of a particular type of infobox.\n     *\n     * If the instance doesn't yet exist, it will be created and registered\n     * with the manager.\n     *\n     * Args:\n     *     InfoboxViewType (prototype):\n     *         The type of infobox to return.\n     *\n     * Returns:\n     *     RB.BaseInfoboxView:\n     *     The resulting infobox instance.\n     */\n    getOrCreateInfobox(InfoboxViewType) {\n        const infoboxID = InfoboxViewType.prototype.infoboxID;\n        console.assert(infoboxID,\n                       'RB.BaseInfoboxView subclasses must have an ' +\n                       'infoboxID defined.');\n\n        let view = this._infoboxViews[infoboxID];\n\n        if (view) {\n            return view;\n        }\n\n        view = new InfoboxViewType();\n        view.$el\n            .hide()\n            .on('mouseenter', this._onInfoboxMouseEnter.bind(this))\n            .on('mouseleave', this._onMouseLeave.bind(this))\n            .appendTo(document.body);\n\n        this._infoboxViews[infoboxID] = view;\n\n        return view;\n    },\n\n    /**\n     * Load the contents for an infobox and display it.\n     *\n     * This will perform a HTTP GET on the infobox URL for the given target\n     * and then show the infobox with those contents. If the URL has already\n     * been fetched, the infobox will be displayed immediately and then the\n     * contents replaced once fetched.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The jQuery target element the infobox is being shown for.\n     *\n     *     infoboxView (RB.BaseInfoboxView):\n     *         The infobox view that will contain the HTML contents.\n     */\n    _loadInfobox($target, infoboxView) {\n        console.assert(\n            $target.length === 1,\n            'Too many targets matched when fetching infobox contents');\n\n        const url = infoboxView.getURLForTarget($target);\n        const cachedData = this._cache[url];\n\n        if (cachedData !== undefined) {\n            /*\n             * If we have cached data, show that immediately and update once we\n             * have the result from the server.\n             */\n            infoboxView.setContents(cachedData);\n            this._showInfobox(infoboxView, $target);\n        }\n\n        this._fetchInfoboxContents(url, html => {\n            this._cache[url] = html;\n            infoboxView.setContents(html);\n\n            if (cachedData === undefined) {\n                this._showInfobox(infoboxView, $target);\n            }\n        });\n    },\n\n    /**\n     * Fetch the contents for an infobox from the given URL.\n     *\n     * Args:\n     *     url (string):\n     *         The URL containing the infobox HTML.\n     *\n     *     onDone (function):\n     *         The handler to call when the infobox HTML has been fetched.\n     */\n    _fetchInfoboxContents(url, onDone) {\n        $.ajax(url, {\n            ifModified: true,\n        }).done(onDone);\n    },\n\n    /**\n     * Display an infobox alongside the given target.\n     *\n     * Args:\n     *     infoboxView (RB.BaseInfoboxView):\n     *         The infobox instance to use.\n     *\n     *     $target (jQuery):\n     *         The jQuery element to position the infobox beside.\n     */\n    _showInfobox(infoboxView, $target) {\n        infoboxView.$el\n            .positionToSide($target, _.defaults(infoboxView.positioning, {\n                fitOnScreen: true,\n            }))\n            .fadeIn(this.FADE_IN_MS);\n\n        this._activeInfoboxView = infoboxView;\n    },\n\n    /**\n     * Hide the active infobox.\n     */\n    _hideInfobox() {\n        if (this._activeInfoboxView) {\n            const curInfoboxView = this._activeInfoboxView;\n\n            this._activeInfoboxView.$el.fadeOut(\n                this.FADE_OUT_MS,\n                () => {\n                    /*\n                     * Only clear the active infobox if it hasn't been\n                     * replaced with a new one.\n                     */\n                    if (curInfoboxView === this._activeInfoboxView) {\n                        this._activeInfoboxView = null;\n                    }\n                });\n        }\n    },\n\n    /**\n     * Handler for when the mouse enters the infobox.\n     *\n     * This will prevent the infobox from being hidden after having left the\n     * target.\n     */\n    _onInfoboxMouseEnter() {\n        clearTimeout(this._hideTimeout);\n        this._hideTimeout = null;\n    },\n\n    /**\n     * Handler for when the mouse enters a target.\n     *\n     * This will wait a small amount of time (in case the user is simply\n     * temporarily mousing over the element) and then show the infobox.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The jQuery target element.\n     *\n     *     InfoboxViewType (prototype):\n     *         The type of infobox to show.\n     */\n    _onTargetMouseEnter($target, InfoboxViewType) {\n        clearTimeout(this._hideTimeout);\n        this._hideTimeout = null;\n\n        this._showTimeout = setTimeout(\n            () => {\n                this._showTimeout = null;\n                this._loadInfobox(\n                    $target,\n                    this.getOrCreateInfobox(InfoboxViewType));\n            },\n            this.POPUP_DELAY_MS);\n    },\n\n    /**\n     * Handler for when the mouse leaves a target or infobox.\n     *\n     * If an existing infobox is currently on-screen, it will be faded\n     * out after a brief delay (allowing time to move the mouse onto the\n     * infobox or back onto the target).\n     */\n    _onMouseLeave() {\n        // If we were going to show an infobox, cancel that.\n        clearTimeout(this._showTimeout);\n        this._showTimeout = null;\n\n        // Check if we need to hide any current infobox.\n        if (this._activeInfoboxView) {\n            /*\n             * We have an infobox on the screen, and the mouse is\n             * leaving it. Since there's no other infobox queued up,\n             * begin the process of fading it out, after a delay.\n             */\n            clearTimeout(this._hideTimeout);\n\n            this._hideTimeout = setTimeout(\n                () => {\n                    this._hideInfobox();\n                    this._hideTimeout = null;\n                },\n                this.HIDE_DELAY_MS);\n        }\n    },\n}, {\n    _instance: null,\n\n    /**\n     * Return an instance of the infobox manager.\n     *\n     * If one does not already exist, it will be created.\n     *\n     * Callers should always use this instead of creating an instance\n     * manually.\n     *\n     * Returns:\n     *     RB.InfoboxManagerView:\n     *     The infobox manager instance.\n     */\n    getInstance() {\n        let instance = RB.InfoboxManagerView._instance;\n\n        if (!instance) {\n            instance = new RB.InfoboxManagerView();\n            this._instance = instance;\n        }\n\n        return instance;\n    },\n\n    /**\n     * Create a jQuery function for registering elements with an infobox.\n     *\n     * This is used to create ``$.fn.`` functions that will register all\n     * matching elements as targets for a particular type of infobox.\n     *\n     * Args:\n     *     infoboxViewType (prototype):\n     *         The type of infobox to use for these elements.\n     *\n     * Returns:\n     *     function:\n     *     The resulting function. This should be assigned to a ``$.fn.``\n     *     function.\n     */\n    createJQueryFn(infoboxViewType) {\n        return function() {\n            RB.InfoboxManagerView.getInstance().addTargets(infoboxViewType,\n                                                           this);\n\n            return this;\n        };\n    },\n});\n"]}