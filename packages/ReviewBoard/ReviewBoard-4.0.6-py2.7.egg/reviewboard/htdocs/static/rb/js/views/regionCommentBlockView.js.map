{"version":3,"sources":["regionCommentBlockView.es6.js"],"names":[],"mappings":"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","file":"regionCommentBlockView.js","sourcesContent":["/**\n * Provides a visual region over an image or other document showing comments.\n *\n * This will show a selection rectangle over part of an image or other\n * content indicating there are comments there. It will also show the\n * number of comments, along with a tooltip showing comment summaries.\n *\n * This is meant to be used with a RegionCommentBlock model.\n */\nRB.RegionCommentBlockView = RB.AbstractCommentBlockView.extend({\n    className: 'selection',\n\n    events: _.defaults({\n        'click': '_onClicked',\n        'mousedown': '_onMouseDown'\n    }, RB.AbstractCommentBlockView.prototype.events),\n\n    /**\n     * Initialize RegionCommentBlockView.\n     */\n    initialize() {\n        this._scale = 1.0;\n        this._moveState = {\n            hasMoved: false,\n            initialCursor: {},\n            initialBounds: {},\n            dragCallback: _.noop\n        };\n\n        _.bindAll(this, '_onDrag', '_onWindowMouseUp');\n    },\n\n    /**\n     * Listen to events.\n     */\n    delegateEvents() {\n        RB.AbstractCommentBlockView.prototype.delegateEvents.call(this);\n\n        this.listenTo(\n            this.model,\n            'change:x change:y change:width change:height',\n            this._updateBounds\n        );\n        this.listenTo(this.model, 'change:count', this._updateCount);\n    },\n\n    /**\n     * Un-listen to events.\n     */\n    undelegateEvents() {\n        RB.AbstractCommentBlockView.prototype.undelegateEvents.call(this);\n\n        $(window).off('mousemove', this._onDrag);\n\n        this.stopListening(this.model);\n    },\n\n    /**\n     * Set the selection region size function.\n     *\n     * This function is meant to return the maximum size of the selection\n     * region for the given comment.\n     *\n     * Args:\n     *     func (function):\n     *         A function which will return a size object.\n     */\n    setSelectionRegionSizeFunc(func) {\n        this.selectionRegionSizeFunc = func;\n    },\n\n    /**\n     * Return the selection region size.\n     *\n     * Returns:\n     *     object:\n     *     An object with ``x``, ``y``, ``width``, and ``height`` fields, in\n     *     pixels.\n     */\n    getSelectionRegionSize() {\n        return _.result(this, 'selectionRegionSizeFunc');\n    },\n\n    /**\n     * Initiate a drag operation.\n     *\n     * Args:\n     *     left (number):\n     *         The initial left position of the cursor.\n     *\n     *     top (number):\n     *         The initial top position of the cursor.\n     *\n     *     callback (function):\n     *         A callback function to call once the drag is finished.\n     */\n    _startDragging(left, top, callback) {\n        /*\n         * ``hasMoved`` is used to distinguish dragging from clicking.\n         * ``initialCursor`` and ``initialBounds`` are used to calculate the\n         * new position and size while dragging.\n         */\n        this._moveState.hasMoved = false;\n        this._moveState.initialCursor.left = left;\n        this._moveState.initialCursor.top = top;\n        this._moveState.initialBounds.left = this.$el.position().left;\n        this._moveState.initialBounds.top = this.$el.position().top;\n        this._moveState.initialBounds.width = this.$el.width();\n        this._moveState.initialBounds.height = this.$el.height();\n        this._moveState.dragCallback = callback;\n\n        $(window).on('mousemove', this._onDrag);\n    },\n\n    /**\n     * End a drag operation.\n     */\n    _endDragging() {\n        /*\n         * Unset the dragging flag after the stack unwinds, so that the\n         * click event can handle it properly.\n         */\n        _.defer(() => { this._moveState.hasMoved = false; });\n\n        $(window).off('mousemove', this._onDrag);\n    },\n\n    /**\n     * Move the comment region to a new position.\n     *\n     * Args:\n     *     left (number):\n     *         The new X-coordinate of the mouse at the end of the drag\n     *         operation, relative to the page.\n     *\n     *     top (number):\n     *         The new Y-coordinate of the mouse at the end of the drag\n     *         operation, relative to the page.\n     */\n    _moveTo(left, top) {\n        const region = this.getSelectionRegionSize();\n        const maxLeft = region.width - (this.model.get('width') * this._scale);\n        const maxTop = region.height - (this.model.get('height') * this._scale);\n        const newLeft = (this._moveState.initialBounds.left +\n                         left - this._moveState.initialCursor.left);\n        const newTop = (this._moveState.initialBounds.top +\n                        top - this._moveState.initialCursor.top);\n\n        this.model.set({\n            x: RB.MathUtils.clip(newLeft, 0, maxLeft) / this._scale,\n            y: RB.MathUtils.clip(newTop, 0, maxTop) / this._scale\n        });\n    },\n\n    /*\n     * Resize (change with and height of) the comment block.\n     *\n     * Args:\n     *     left (number):\n     *         The new X-coordinate of the mouse at the end of the drag\n     *         operation, relative to the page.\n     *\n     *     top (number):\n     *         The new Y-coordinate of the mouse at the end of the drag\n     *         operation, relative to the page.\n     */\n    _resizeTo(left, top) {\n        const region = this.getSelectionRegionSize();\n        const maxWidth = region.width - (this.model.get('x') * this._scale);\n        const maxHeight = region.height - (this.model.get('y') * this._scale);\n        const newWidth = (this._moveState.initialBounds.width +\n                          left - this._moveState.initialCursor.left);\n        const newHeight = (this._moveState.initialBounds.height +\n                           top - this._moveState.initialCursor.top);\n\n        this.model.set({\n            width: RB.MathUtils.clip(newWidth, 0, maxWidth) / this._scale,\n            height: RB.MathUtils.clip(newHeight, 0, maxHeight) / this._scale\n        });\n    },\n\n    /**\n     * Handle a mousedown event.\n     *\n     * Mouse-down means one of these in this view:\n     * 1. click\n     * 2. start of dragging to move the comment\n     * 3. start of dragging to resize the comment\n     *\n     * This method looks at ``e.target`` and does the appropriate action.\n     *\n     * Args:\n     *     e (Event):\n     *         The event which triggered the callback.\n     */\n    _onMouseDown(e) {\n        if (this.model.canUpdateBounds()) {\n            e.preventDefault();\n            e.stopPropagation();\n\n            let draggingCallback = null;\n            if (e.target === this._$flag.get(0)) {\n                draggingCallback = this._moveTo;\n            } else if (e.target === this._$resizeIcon.get(0)) {\n                draggingCallback = this._resizeTo;\n            }\n\n            if (draggingCallback) {\n                this._startDragging(e.pageX, e.pageY, draggingCallback);\n\n                $(window).one('mouseup', this._onWindowMouseUp);\n            }\n        }\n    },\n\n    /**\n     * Handle a mouseup event.\n     *\n     * If something has been dragged, end dragging and update the comment's\n     * bounds.\n     *\n     * If not, the event was actually a ``click`` event and we call the\n     * superclass' click handler.\n     */\n    _onWindowMouseUp() {\n        if (this._moveState.hasMoved) {\n            this.model.saveDraftCommentBounds();\n        }\n\n        this._endDragging();\n    },\n\n    /**\n     * Handle a drag event.\n     *\n     * Set moveState.hasMoved to ``true`` to prevent triggering a ``click``\n     * event, and move to view to dragged location.\n     *\n     * Args:\n     *     e (Event):\n     *         The event which triggered the callback.\n     */\n    _onDrag(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.hideTooltip();\n\n        this._moveState.hasMoved = true;\n        this._moveState.dragCallback.call(this, e.pageX, e.pageY);\n    },\n\n    /**\n     * Render the comment block.\n     *\n     * Along with the block's rectangle, a floating tooltip will also be\n     * created that displays summaries of the comments.\n     */\n    renderContent() {\n        this._updateBounds();\n\n        if (this.model.canUpdateBounds()) {\n            this.$el.addClass('can-update-bound');\n\n            this._$resizeIcon = $('<div class=\"resize-icon\" />')\n                .appendTo(this.$el);\n        }\n\n        this._$flag = $('<div class=\"selection-flag\" />')\n            .appendTo(this.$el);\n\n        this._updateCount();\n    },\n\n    /**\n     * Position the comment dialog to the side of the flag.\n     *\n     * Args:\n     *     commentDlg (RB.CommentDialogView):\n     *         The comment dialog.\n     */\n    positionCommentDlg(commentDlg) {\n        commentDlg.positionBeside(this._$flag, {\n            side: 'b',\n            fitOnScreen: true\n        });\n    },\n\n    /**\n     * Update the position and size of the comment block element.\n     *\n     * The new position and size will reflect the x, y, width, and height\n     * properties in the model.\n     */\n    _updateBounds() {\n        this.$el\n            .move(this.model.get('x') * this._scale,\n                  this.model.get('y') * this._scale,\n                  'absolute')\n            .width(this.model.get('width') * this._scale)\n            .height(this.model.get('height') * this._scale);\n    },\n\n    /**\n     * Update the displayed count of comments.\n     */\n    _updateCount() {\n        if (this._$flag) {\n            this._$flag.text(this.model.get('count'));\n        }\n    },\n\n    /**\n     * Handle a click event.\n     *\n     * If the click event is not the end result of a drag operation, this\n     * will emit the \"clicked\" event on the view.\n     */\n    _onClicked() {\n        if (!this._moveState.hasMoved) {\n            this.trigger('clicked');\n        }\n    },\n\n    /**\n     * Set the zoom scale.\n     *\n     * Args:\n     *     scale (number):\n     *         A scaling factor. 1.0 is a 1:1 pixel ratio, 0.5 is displayed\n     *         at half size, etc.\n     */\n    setScale(scale) {\n        this._scale = scale;\n        this._updateBounds();\n    }\n});\n"]}