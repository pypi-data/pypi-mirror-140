{"version":3,"sources":["reviewReplyModel.es6.js"],"names":[],"mappings":"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","file":"reviewReplyModel.js","sourcesContent":["/**\n * A review reply.\n *\n * Encapsulates replies to a top-level review.\n *\n * Model Attributes:\n *     forceTextType (string):\n *         The text type to request for text in all responses.\n *\n *     includeTextTypes (string):\n *         A comma-separated list of text types to include in responses.\n *\n *     rawTextFields (object):\n *         The contents of the raw text fields, if forceTextType is used and\n *         the caller fetches or posts with includeTextTypes=raw. The keys in\n *         this object are the field names, and the values are the raw versions\n *         of those attributes.\n *\n *     review (RB.Review):\n *         The review that this reply is replying to.\n *\n *     public (boolean):\n *         Whether this reply has been published.\n *\n *     bodyTop (string):\n *         The reply to the original review's ``bodyTop``.\n *\n *     bodyTopRichText (boolean):\n *         Whether the ``bodyTop`` field should be rendered as Markdown.\n *\n *     bodyBottom (string):\n *         The reply to the original review's ``bodyBottom``.\n *\n *     bodyBottomRichText (boolean):\n *         Whether the ``bodyBottom`` field should be rendered as Markdown.\n *\n *     timestamp (string):\n *         The timestamp of this reply.\n */\nRB.ReviewReply = RB.BaseResource.extend({\n    defaults() {\n        return _.defaults({\n            forceTextType: null,\n            includeTextTypes: null,\n            rawTextFields: {},\n            review: null,\n            'public': false,\n            bodyTop: null,\n            bodyTopRichText: false,\n            bodyBottom: null,\n            bodyBottomRichText: false,\n            timestamp: null\n        }, RB.BaseResource.prototype.defaults());\n    },\n\n    rspNamespace: 'reply',\n    listKey: 'replies',\n\n    extraQueryArgs: {\n        'force-text-type': 'html',\n        'include-text-types': 'raw'\n    },\n\n    attrToJsonMap: {\n        bodyBottom: 'body_bottom',\n        bodyBottomRichText: 'body_bottom_text_type',\n        bodyTop: 'body_top',\n        bodyTopRichText: 'body_top_text_type',\n        forceTextType: 'force_text_type',\n        includeTextTypes: 'include_text_types'\n    },\n\n    serializedAttrs: [\n        'forceTextType',\n        'includeTextTypes',\n        'bodyTop',\n        'bodyTopRichText',\n        'bodyBottom',\n        'bodyBottomRichText',\n        'public'\n    ],\n\n    deserializedAttrs: [\n        'bodyTop',\n        'bodyBottom',\n        'public',\n        'timestamp'\n    ],\n\n    serializers: {\n        forceTextType: RB.JSONSerializers.onlyIfValue,\n        includeTextTypes: RB.JSONSerializers.onlyIfValue,\n        bodyTopRichText: RB.JSONSerializers.textType,\n        bodyBottomRichText: RB.JSONSerializers.textType,\n        'public': value => value ? true : undefined\n    },\n\n    COMMENT_LINK_NAMES: [\n        'diff_comments',\n        'file_attachment_comments',\n        'general_comments',\n        'screenshot_comments'\n    ],\n\n    /**\n     * Parse the response from the server.\n     *\n     * Args:\n     *     rsp (object):\n     *         The response from the server.\n     *\n     * Returns:\n     *     object:\n     *     The attribute values to set on the model.\n     */\n    parseResourceData(rsp) {\n        const rawTextFields = rsp.raw_text_fields || rsp;\n        const data = RB.BaseResource.prototype.parseResourceData.call(\n            this, rsp);\n\n        data.bodyTopRichText =\n            (rawTextFields.body_top_text_type === 'markdown');\n        data.bodyBottomRichText =\n            (rawTextFields.body_bottom_text_type === 'markdown');\n        data.rawTextFields = rsp.raw_text_fields || {};\n\n        return data;\n    },\n\n    /**\n     * Publish the reply.\n     *\n     * Before publishing, the \"publishing\" event will be triggered.\n     * After successfully publishing, \"published\" will be triggered.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the save operation.\n     *\n     *     context (object):\n     *         Context to bind when calling callbacks.\n     */\n    publish(options={}, context=undefined) {\n        this.trigger('publishing');\n\n        this.ready({\n            ready: () => {\n                this.set('public', true);\n                this.save({\n                    data: {\n                        'public': 1,\n                        trivial: options.trivial ? 1 : 0\n                    },\n                    success: () => {\n                        this.trigger('published');\n\n                        if (_.isFunction(options.success)) {\n                            options.success.call(context);\n                        }\n                    },\n                    error: (model, xhr) => {\n                        model.trigger('publishError', xhr.errorText);\n\n                        if (_.isFunction(options.error)) {\n                            options.error.call(context, model, xhr);\n                        }\n                    }\n                });\n            }\n        });\n    },\n\n    /**\n     * Discard the reply if it's empty.\n     *\n     * If the reply doesn't have any remaining comments on the server, then\n     * this will discard the reply.\n     *\n     * When we've finished checking, options.success will be called. It\n     * will be passed true if discarded, or false otherwise.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the save operation.\n     *\n     *     context (object):\n     *         Context to bind when calling callbacks.\n     */\n    discardIfEmpty(options={}, context=undefined) {\n        options = _.bindCallbacks(options, context);\n\n        this.ready({\n            ready: () => {\n                if (this.isNew() ||\n                    this.get('bodyTop') ||\n                    this.get('bodyBottom')) {\n                    if (_.isFunction(options.success)) {\n                        options.success(false);\n                    }\n\n                    return;\n                }\n\n                this._checkCommentsLink(0, options, context);\n            },\n\n            error: options.error\n        });\n    },\n\n    /**\n     * Check if there are comments, given the comment type.\n     *\n     * This is part of the discardIfEmpty logic.\n     *\n     * If there are comments, we'll give up and call options.success(false).\n     *\n     * If there are no comments, we'll move on to the next comment type. If\n     * we're done, the reply is discarded, and options.success(true) is called.\n     *\n     * Args:\n     *     linkNamesIndex (number):\n     *         An index into the ``COMMENT_LINK_NAMES`` Array.\n     *\n     *     options (object):\n     *         Options for the save operation.\n     *\n     *     context (object):\n     *         Context to bind when calling callbacks.\n     */\n    _checkCommentsLink(linkNameIndex, options, context) {\n        const linkName = this.COMMENT_LINK_NAMES[linkNameIndex];\n        const url = this.get('links')[linkName].href;\n\n        RB.apiCall({\n            type: 'GET',\n            url: url,\n            success: rsp => {\n                if (rsp[linkName].length > 0) {\n                    if (_.isFunction(options.success)) {\n                        options.success(false);\n                    }\n                } else if (linkNameIndex < this.COMMENT_LINK_NAMES.length - 1) {\n                    this._checkCommentsLink(linkNameIndex + 1, options,\n                                            context);\n                } else {\n                    this.destroy(\n                    _.defaults({\n                        success: () => {\n                            if (_.isFunction(options.success)) {\n                                options.success(true);\n                            }\n                        }\n                    }, options),\n                    context);\n                }\n            },\n            error: options.error\n        });\n    }\n});\n_.extend(RB.ReviewReply.prototype, RB.DraftResourceModelMixin);\n"]}