{"version":3,"sources":["diffFragmentQueueView.es6.js"],"names":[],"mappings":"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","file":"diffFragmentQueueView.js","sourcesContent":["/**\n * Queues loading of diff fragments from a page.\n *\n * This is used to load diff fragments one-by-one, and to intelligently\n * batch the loads to only fetch at most one set of fragments per file.\n */\nRB.DiffFragmentQueueView = Backbone.View.extend({\n    /**\n     * Initialize the queue.\n     *\n     * Args:\n     *     options (object):\n     *         Options passed to this view.\n     *\n     * Returns:\n     *     containerPrefix (string):\n     *         The prefix to prepend to diff comment IDs when forming\n     *         container element IDs.\n     *\n     *     diffFragmentViewOptions (object, optional):\n     *         Options to pass to each :js:class:`RB.DiffFragmentView` that's\n     *         created.\n     *\n     *     reviewRequestPath (string):\n     *         The URL for the review request that diff fragments will be\n     *         loaded from.\n     *\n     *     queueName (string):\n     *         The name of the diff loading queue.\n     */\n    initialize(options) {\n        this._containerPrefix = options.containerPrefix;\n        this._diffFragmentViewOptions = options.diffFragmentViewOptions;\n        this._fragmentsBasePath =\n            `${options.reviewRequestPath}_fragments/diff-comments/`;\n        this._queueName = options.queueName;\n\n        this._queue = {};\n        this._saved = {};\n    },\n\n    /**\n     * Queue the load of a diff fragment from the server.\n     *\n     * This will be added to a list, which will fetch the comments in batches\n     * based on file IDs.\n     *\n     * Args:\n     *     commentID (string):\n     *         The ID of the comment to queue.\n     *\n     *     key (string):\n     *         The key for the queue. Each comment with the same key will be\n     *         loaded in a batch. This will generally be the ID of a file.\n     *\n     *     onFragmentRendered (function, optional):\n     *         Optional callback for when the view for the fragment has\n     *         rendered. Contains the view as a parameter.\n     */\n    queueLoad(commentID, key, onFragmentRendered) {\n        const queue = this._queue;\n\n        if (!queue[key]) {\n            queue[key] = [];\n        }\n\n        queue[key].push({\n            commentID: commentID,\n            onFragmentRendered: onFragmentRendered || null,\n        });\n    },\n\n    /**\n     * Save a comment's loaded diff fragment for the next load operation.\n     *\n     * If the comment's diff fragment was already loaded, it will be\n     * temporarily stored until the next load operation involving that\n     * comment. Instead of loading the fragment from the server, the saved\n     * fragment's HTML will be used instead.\n     *\n     * Args:\n     *     commentID (string):\n     *         The ID of the comment to save.\n     */\n    saveFragment(commentID) {\n        const $el = this._getCommentContainer(commentID);\n\n        if ($el.length === 1 && $el.data('diff-fragment-view')) {\n            this._saved[commentID] = $el.html();\n        }\n    },\n\n    /**\n     * Load all queued diff fragments.\n     *\n     * The diff fragments for each keyed set in the queue will be loaded as\n     * a batch. The resulting fragments will be injected into the DOM.\n     *\n     * Any existing fragments that were saved will be loaded from the cache\n     * without requesting them from the server.\n     *\n     * Args:\n     *     onDone (function, optional):\n     *         Callback for when all fragments have been loaded.\n     */\n    loadFragments(onDone) {\n        if (_.isEmpty(this._queue) && _.isEmpty(this._saved)) {\n            if (_.isFunction(onDone)) {\n                onDone();\n            }\n\n            return;\n        }\n\n        const queueName = this._queueName;\n\n        _.each(this._queue, queuedLoads => {\n            $.funcQueue(queueName).add(() => {\n                const pendingCommentIDs = [];\n                const onFragmentRenderedFuncs = {};\n\n                /*\n                 * Check if there are any comment IDs that have been saved.\n                 * We don't need to reload these from the server.\n                 */\n                for (let i = 0; i < queuedLoads.length; i++) {\n                    const queuedLoad = queuedLoads[i];\n                    const commentID = queuedLoad.commentID;\n                    const onFragmentRendered =\n                        _.isFunction(queuedLoad.onFragmentRendered)\n                        ? queuedLoad.onFragmentRendered\n                        : null;\n\n                    if (this._saved.hasOwnProperty(commentID)) {\n                        const html = this._saved[commentID];\n\n                        const container = this._getCommentContainer(commentID);\n                        console.assert(container);\n\n                        let view = container.data('diff-fragment-view');\n\n                        if (view) {\n                            view.$el.html(html);\n                            view.render();\n                        } else {\n                            view = this._renderFragment(container, commentID,\n                                                        html);\n                        }\n\n                        if (onFragmentRendered) {\n                            onFragmentRendered(view);\n                        }\n\n                        delete this._saved[commentID];\n                    } else {\n                        pendingCommentIDs.push(commentID);\n                        onFragmentRenderedFuncs[commentID] =\n                            onFragmentRendered;\n                    }\n                }\n\n                if (pendingCommentIDs.length > 0) {\n                    /*\n                     * There are some comment IDs we don't have. Load these\n                     * from the server.\n                     *\n                     * Once these are loaded, they'll call next() on the queue\n                     * to process the next batch.\n                     */\n                    this._loadDiff(pendingCommentIDs.join(','), {\n                        queueName: queueName,\n                        onFragmentRendered: (commentID, view) => {\n                            if (onFragmentRenderedFuncs[commentID]) {\n                                onFragmentRenderedFuncs[commentID](view);\n                            }\n                        },\n                        onDone: () => $.funcQueue(queueName).next(),\n                    });\n                } else {\n                    /*\n                     * We processed all we need to process above. Go to the\n                     * next queue.\n                     */\n                    $.funcQueue(queueName).next();\n                }\n            });\n        });\n\n        if (_.isFunction(onDone)) {\n            $.funcQueue(queueName).add(() => {\n                onDone();\n                $.funcQueue(queueName).next();\n            });\n        }\n\n        // Clear the list.\n        this._queue = {};\n\n        $.funcQueue(queueName).start();\n    },\n\n    /**\n     * Return the container for a particular comment.\n     *\n     * Args:\n     *     commentID (string):\n     *         The ID of the comment.\n     *\n     * Returns:\n     *     jQuery:\n     *     The comment container, wrapped in a jQuery element. The caller\n     *     may want to check the length to be sure the container was found.\n     */\n    _getCommentContainer(commentID) {\n        return $(`#${this._containerPrefix}_${commentID}`);\n    },\n\n    /**\n     * Load a diff fragment for the given comment IDs and options.\n     *\n     * This will construct the URL for the relevant diff fragment and load\n     * it from the server.\n     *\n     * Args:\n     *     commentIDs (string):\n     *         A string of comment IDs to load fragments for.\n     *\n     *     options (object, optional):\n     *         Options for the loaded diff fragments.\n     *\n     * Option Args:\n     *     linesOfContext (string):\n     *         The lines of context to load for the diff. This is a string\n     *         containing a comma-separated set of line counts in the form\n     *         of ``numLinesBefore,numLinesAfter``.\n     *\n     *     onDone (function):\n     *         A function to call after the diff has been loaded.\n     *\n     *     queueName (string):\n     *         The name of the load queue. This is used to load batches of\n     *         fragments sequentially.\n     */\n    _loadDiff(commentIDs, options={}) {\n        const containerPrefix = this._containerPrefix;\n        const queryArgs = [];\n        const onFragmentRendered = (_.isFunction(options.onFragmentRendered)\n                                    ? options.onFragmentRendered\n                                    : null);\n\n        if (options.linesOfContext !== undefined) {\n            queryArgs.push(`lines_of_context=${options.linesOfContext}`);\n        }\n\n        if (!containerPrefix.includes('draft')) {\n            queryArgs.push('allow_expansion=1');\n        }\n\n        queryArgs.push(TEMPLATE_SERIAL);\n\n        RB.apiCall({\n            url: `${this._fragmentsBasePath}${commentIDs}/`,\n            data: queryArgs.join('&'),\n            dataType: 'arraybuffer',\n            type: 'GET',\n            success: arrayBuffer => {\n                const dataView = new DataView(arrayBuffer);\n                const len = dataView.byteLength;\n                let pos = 0;\n                let totalFragments = 0;\n                let totalRenders = 0;\n                let done = false;\n\n                const onFragmentLoaded = (commentID, html) => {\n                    /* Set the HTML in the container. */\n                    const containerID = `#${containerPrefix}_${commentID}`;\n                    const $container = $(containerID);\n\n                    if ($container.length === 0) {\n                        /*\n                         * This doesn't actually exist. We may be dealing with\n                         * inconsistent state due to something missing in the\n                         * database. We don't want to break the page if this\n                         * happens, so log and skip the entry.\n                         */\n                        console.error('Unable to find container %s for ' +\n                                      'comment ID %s. There may be missing ' +\n                                      'state in the database.',\n                                      containerID, commentID);\n                    } else {\n                        const view = this._renderFragment(\n                            $(`#${containerPrefix}_${commentID}`),\n                            commentID,\n                            html);\n\n                        if (onFragmentRendered) {\n                            onFragmentRendered(commentID, view);\n                        }\n                    }\n\n                    totalRenders++;\n\n                    if (done && totalRenders === totalFragments &&\n                        _.isFunction(options.onDone)) {\n                        /*\n                         * We've parsed and rendered all fragments, so we're\n                         * officially done.\n                         */\n                        options.onDone();\n                    }\n                }\n\n                while (!done) {\n                    const parsed = this._parseDiffFragmentFromPayload(\n                        arrayBuffer, dataView, pos);\n\n                    totalFragments++;\n                    pos = parsed.pos;\n                    done = (pos >= len);\n\n                    parsed.load(onFragmentLoaded);\n                }\n            }\n        });\n    },\n\n    /**\n     * Parse a single diff fragment from the payload.\n     *\n     * This will parse out information about the fragment (the comment ID and\n     * HTML) and return a response containing the new position and a function\n     * to call in order to load the parsed fragment.\n     *\n     * Args:\n     *     arrayBuffer (ArrayBuffer):\n     *         The array buffer being parsed.\n     *\n     *     dataView (DataView):\n     *         The data view on top of the array buffer, used to extract\n     *         information.\n     *\n     *     pos (number):\n     *         The current position within the array buffer.\n     *\n     * Returns:\n     *     object:\n     *     An object with two keys:\n     *\n     *     ``pos``:\n     *         The next position to parse.\n     *\n     *     ``load``:\n     *         A function for loading the fragment content. This takes a\n     *         callback function as an argument containing ``commentID`` and\n     *         ``html`` arguments.\n     */\n    _parseDiffFragmentFromPayload(arrayBuffer, dataView, pos) {\n        /* Read the comment ID. */\n        const commentID = dataView.getUint32(pos, true);\n        pos += 4;\n\n        /* Read the length of the HTML. */\n        const htmlLen = dataView.getUint32(pos, true);\n        pos += 4;\n\n        /* Read the HTML position for later. */\n        const htmlStart = pos;\n        pos += htmlLen;\n\n        return {\n            pos: pos,\n            load(cb) {\n                RB.DataUtils.readBlobAsString(\n                    new Blob([arrayBuffer.slice(htmlStart,\n                                                htmlStart + htmlLen)]),\n                    html => cb(commentID, html));\n            },\n        };\n    },\n\n    /**\n     * Render a diff fragment on the page.\n     *\n     * This will set up a view for the diff fragment, if one is not already\n     * created, and render it on the page.\n     *\n     * It will also mark the fragment for updates with the scroll manager\n     * so that if the user is scrolled to a location past the fragment, the\n     * resulting size change for the fragment won't cause the page to jump.\n     *\n     * Args:\n     *     $container (jQuery):\n     *         The container element where the fragment will be injected.\n     *\n     *     commentID (number):\n     *         The ID of the comment.\n     *\n     *     html (string):\n     *         The HTML contents of the fragment.\n     */\n    _renderFragment($container, commentID, html) {\n        RB.scrollManager.markForUpdate($container);\n\n        $container.html(html);\n\n        let view = $container.data('diff-fragment-view');\n\n        if (!view) {\n            view = new RB.DiffFragmentView(_.defaults({\n                el: $container,\n                loadDiff: options => {\n                    RB.setActivityIndicator(true, {type: 'GET'});\n\n                    this._loadDiff(commentID, _.defaults({\n                        onDone() {\n                            RB.setActivityIndicator(false, {});\n\n                            if (options.onDone) {\n                                options.onDone();\n                            }\n                        },\n                    }, options));\n                },\n            }, this._diffFragmentViewOptions));\n            $container.data('diff-fragment-view', view);\n        }\n\n        view.render();\n\n        RB.scrollManager.markUpdated($container);\n\n        return view;\n    },\n});\n"]}