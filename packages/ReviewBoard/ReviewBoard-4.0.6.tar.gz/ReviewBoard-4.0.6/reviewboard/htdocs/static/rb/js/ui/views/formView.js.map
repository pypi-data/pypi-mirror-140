{"version":3,"sources":["formView.es6.js"],"names":[],"mappings":"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","file":"formView.js","sourcesContent":["/**\n * A view for managing state on a form.\n *\n * This provides some standard behavior for setting up form widgets and\n * handling collapsable fieldsets, along with managing subforms.\n */\nRB.FormView = Backbone.View.extend({\n    events: {\n        'click .rb-c-form-fieldset__toggle': '_onToggleFieldSetClicked',\n    },\n\n    /**\n     * Initialize the view.\n     */\n    initialize() {\n        this._$subforms = null;\n        this._subformsByGroup = {};\n        this._formWidgetsInitialized = false;\n    },\n\n    /**\n     * Render the view.\n     *\n     * This will set up any subforms that might be available within the form.\n     *\n     * Returns:\n     *     RB.FormView:\n     *     This object, for chaining.\n     */\n    render() {\n        this._$subforms = this.$('.rb-c-form-fieldset.-is-subform');\n\n        if (this._$subforms.length > 0) {\n            this._setupSubforms();\n        }\n\n        this.setupFormWidgets();\n\n        return this;\n    },\n\n    /**\n     * Set up state for widgets on the form.\n     *\n     * This will ensure that widgets are set up correctly on the form, or on\n     * a part of the form. This will take care to re-initialize widgets if\n     * they've already been initialized before (useful when dynamically adding\n     * new sections of a form).\n     *\n     * This supports only a few known types of widgets (Django date/time\n     * widgets and related object selectors).\n     *\n     * Args:\n     *     $el (jQuery, optional):\n     *         A starting point for finding the widgets. If not provided, all\n     *         widgets in the form will be set up.\n     */\n    setupFormWidgets($el) {\n        if ($el === undefined) {\n            $el = this.$el;\n        }\n\n        /*\n         * Update some state for Django widgets. We've quite possibly made use\n         * of widgets in the form that need to be initialized, and Django\n         * doesn't have much fine-grained support for doing this, so we need\n         * to take a heavy-handed approach.\n         *\n         * Django (up through 3.0 at least) performs similar logic.\n         */\n        if (window.DateTimeShortcuts &&\n            $el.find('.datetimeshortcuts').length > 0) {\n            if (this._formWidgetsInitialized) {\n                /*\n                 * Yep, we have to remove *all* of these... DateTimeShortcuts\n                 * has no granular widget support.\n                 */\n                $('.datetimeshortcuts').remove();\n            }\n\n            DateTimeShortcuts.init();\n        }\n\n        if (window.SelectFilter) {\n            $el.find('.selectfilter').each((i, el) => {\n                const parts = el.name.split('-');\n                SelectFilter.init(el.id, parts[parts.length - 1], false);\n            });\n\n            $el.find('.selectfilterstacked').each((i, el) => {\n                const parts = el.name.split('-');\n                SelectFilter.init(el.id, parts[parts.length - 1], true);\n            });\n        }\n\n        this._formWidgetsInitialized = true;\n    },\n\n    /**\n     * Set the visibility of one or more subforms.\n     *\n     * This will toggle visibility of a single subform, hide all subforms,\n     * or hide all subforms except one.\n     *\n     * Args:\n     *     options (object):\n     *         Options to control visibility.\n     *\n     * Option Args:\n     *     group (string):\n     *         The registered group for the subforms.\n     *\n     *     hideOthers (boolean):\n     *         Whether to hide any subforms other than the one specified by\n     *         ``subformID``.\n     *\n     *     subformID (string):\n     *         A single subform to set the visibility state for. If not\n     *         provided, this will toggle visibility of all subforms in the\n     *         group.\n     *\n     *     visible (boolean):\n     *         Whether to make the selected subform visible. This is only used\n     *         if ``hideOthers`` is not provided.\n     */\n    setSubformVisibility(options) {\n        console.assert(_.isObject(options),\n                       'An options object must be provided.');\n\n        const group = options.group;\n        const subformID = options.subformID;\n        const visible = options.visible;\n\n        console.assert(group, 'Missing option \"group\"');\n\n        const subformIDs = this._subformsByGroup[group];\n        console.assert(subformIDs, `Invalid subform group ${group}`);\n\n        if (options.hideOthers || !subformID) {\n            _.each(subformIDs, ($subform, id) => {\n                const isHidden = (subformID === undefined\n                                  ? !visible\n                                  : (id !== subformID));\n\n                $subform.prop({\n                    disabled: isHidden,\n                    hidden: isHidden,\n                });\n            });\n        } else {\n            console.assert(visible !== undefined, 'Missing option \"visible\"');\n\n            const $subform = subformIDs[subformID];\n            console.assert($subform, `Invalid subform ID ${subformID}`);\n\n            $subform.prop({\n                disabled: !visible,\n                hidden: !visible,\n            });\n        }\n    },\n\n    /**\n     * Set up state and event handlers for subforms.\n     *\n     * This will begin tracking all the subforms on the page, and connect\n     * subform visibility to any associated controllers.\n     */\n    _setupSubforms() {\n        const configuredControllers = {};\n\n        this._$subforms.each((i, subformEl) => {\n            const $subform = $(subformEl);\n            const controllerID = $subform.data('subform-controller');\n            const subformID = $subform.data('subform-id');\n            let group = $subform.data('subform-group');\n            let $controller;\n\n            if (!subformID) {\n                console.error('Subform %o is missing data-subform-id=',\n                              subformEl);\n                return;\n            }\n\n            if (!group && !controllerID) {\n                console.error(\n                    'Subform %o is missing either data-subform-group= ' +\n                    'or data-subform-controller=',\n                    subformEl);\n                return;\n            }\n\n            /*\n             * If we have a controller ID provided, look it up and ensure\n             * we're using the right group.\n             */\n            if (controllerID) {\n                $controller = this.$(`#${controllerID}`);\n\n                console.assert($controller.length === 1,\n                               `Missing controller #${controllerID}`);\n\n                const controllerGroup =\n                    $controller.data('subform-group');\n\n                /*\n                 * If the subform specifies an explicit group, and it\n                 * specified a controller, make sure they match up. While\n                 * we could work around an issue here, we'd rather make the\n                 * developer fix their code.\n                 */\n                if (group === undefined) {\n                    group = controllerGroup;\n                } else if (controllerGroup !== group) {\n                    console.error('Subform %o and controller %s have ' +\n                                  'different values for data-subform-group',\n                                  subformEl, controllerID);\n                    return;\n                }\n            }\n\n            /* Register the subforms so that they can be looked up later. */\n            if (!this._subformsByGroup.hasOwnProperty(group)) {\n                this._subformsByGroup[group] = {};\n            }\n\n            this._subformsByGroup[group][subformID] = $subform;\n\n            /*\n             * If we have a controller associated, set the current subform's\n             * visibility based on that value, and listen for changes.\n             */\n            if ($controller) {\n                this.setSubformVisibility({\n                    group: group,\n                    subformID: subformID,\n                    visible: $controller.val() === subformID,\n                });\n\n                if (!configuredControllers[controllerID]) {\n                    configuredControllers[controllerID] = true;\n\n                    $controller.on('change', () => this.setSubformVisibility({\n                        group: group,\n                        subformID: $controller.val(),\n                        visible: true,\n                        hideOthers: true,\n                    }));\n                }\n            }\n        });\n    },\n\n    /**\n     * Handle the showing or collapsing of a fieldset.\n     *\n     * This will set the appropriate state on the fieldset to show or hide\n     * the content.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The click event on the Show/Hide button.\n     */\n    _onToggleFieldSetClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const $toggle = $(e.target);\n        const $fieldset = $toggle.closest('.rb-c-form-fieldset');\n\n        if ($fieldset.hasClass('-is-collapsed')) {\n            $fieldset.removeClass('-is-collapsed');\n            $toggle.text(gettext('(Hide)'));\n        } else {\n            $fieldset.addClass('-is-collapsed');\n            $toggle.text(gettext('(Show)'));\n        }\n    },\n});\n"]}