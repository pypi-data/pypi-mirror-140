{"version":3,"sources":["diffFragmentView.es6.js"],"names":[],"mappings":"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","file":"diffFragmentView.js","sourcesContent":["/**\n * A view for managing a loaded diff fragment and its state.\n *\n * This displays a fragment of a diff, offering options for expanding and\n * collapsing content.\n */\nRB.DiffFragmentView = Backbone.View.extend({\n    events: {\n        'click .diff-expand-btn': '_onExpandButtonClicked',\n        'click .diff-collapse-btn': '_onCollapseButtonClicked',\n        'mouseenter': '_tryShowControlsDelayed',\n        'mouseleave': '_tryHideControlsDelayed',\n    },\n\n    /** The exposed headers height to show when collapsed. */\n    COLLAPSED_HEADERS_HEIGHT: 4,\n\n    /** The timeout for a mouseout event to fire after it actually occurs. */\n    _controlsHoverTimeout: 250,\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options that control the view. This must at least provide\n     *         ``loadDiff``.\n     *\n     * Option Args:\n     *     collapsible (bool, optional):\n     *         Whether or not the controls on the view can be collapsed. If\n     *         collapsible, they will also start collapsed. This defaults to\n     *         ``false``.\n     *\n     *     loadDiff (function):\n     *         The function to call to load more of the diff. This must be\n     *         provided by the caller.\n     */\n    initialize(options={}) {\n        this._loadDiff = options.loadDiff;\n        this._collapsible = !!options.collapsible;\n\n        this._$table = null;\n        this._$thead = null;\n        this._$diffHeaders = null;\n        this._$controls = null;\n\n        this._centeredMgr = null;\n        this._contextExpanded = false;\n    },\n\n    /**\n     * Render the view.\n     *\n     * This will start the view off in a collapsed mode.\n     *\n     * Returns:\n     *     RB.DiffFragmentView:\n     *     This instance, for chaining.\n     */\n    render() {\n        /*\n         * Make sure this class isn't on the fragment, in case we're\n         * reloading content.\n         */\n        this.$el.removeClass('allow-transitions');\n\n        this._$table = this.$el.children('table');\n        this._$diffHeaders = this._$table.find('.diff-header');\n        this._$thead = this._$table.children('thead');\n        this._$controls = this._$diffHeaders.find('td > div');\n\n        if (this._collapsible && this.$el.is(':visible')) {\n            this.hideControls();\n        } else {\n            /*\n             * If we're not collapsible, then we're always expanded\n             * by default.\n             */\n            this.showControls();\n        }\n\n        if (this._collapsible) {\n            /*\n             * Once we've hidden the controls, we want to enable transitions for\n             * hovering. We don't apply this before (or make it implicit)\n             * because we don't want all the transitions to take place on page\n             * load, as it's both visually weird and messes with the height\n             * calculation for the collapsed areas.\n             */\n            _.defer(() => this.$el.addClass('allow-transitions'));\n        }\n\n        return this;\n    },\n\n    /**\n     * Show the controls on the specified comment container.\n     */\n    showControls() {\n        /* This will effectively control the opacity of the controls. */\n        this._$table\n            .removeClass('collapsed')\n            .addClass('expanded');\n\n        /*\n         * Undo all the transforms, so that these animate to their normal\n         * positions.\n         */\n        this._$thead.css('transform', '');\n        this._$diffHeaders.css('transform', '');\n    },\n\n    /**\n     * Hide the controls on the specified comment container.\n     *\n     * Args:\n     *     animate (boolean, optional):\n     *         Whether to animate hiding the controls. By default, this is\n     *         ``true``.\n     */\n    hideControls(animate) {\n        /*\n         * Never hide the controls when context has been expanded. It creates\n         * a sort of jarring initial effect.\n         */\n        if (this._contextExpanded) {\n            return;\n        }\n\n        if (animate === false) {\n            this.$el.removeClass('allow-transitions');\n        }\n\n        this._$table\n            .removeClass('expanded')\n            .addClass('collapsed');\n\n        const $firstDiffHeader = this._$diffHeaders.eq(0);\n\n        if ($firstDiffHeader.hasClass('diff-header-above')) {\n            /*\n             * If the first diff header is present, we'll need to transition\n             * the header down to be flush against the collapsed header.\n             */\n            const translateY = $firstDiffHeader.height() -\n                               this.COLLAPSED_HEADERS_HEIGHT;\n\n            this._$thead.css('transform', `translateY(${translateY}px)`);\n        }\n\n        /*\n         * The diff headers won't have the same heights exactly. We need to\n         * compute the proper scale for the correct size per-header.\n         */\n        _.each(this._$diffHeaders, diffHeaderEl => {\n            const $diffHeader = $(diffHeaderEl);\n            const scale = this.COLLAPSED_HEADERS_HEIGHT / $diffHeader.height();\n\n            $diffHeader.css('transform', `scaleY(${scale})`);\n        });\n\n        if (animate === false) {\n            _.defer(() => this.$el.addClass('allow-transitions'));\n        }\n    },\n\n    /*\n     * Common functionality around expand or collapsing the diff fragment.\n     *\n     * This will grab information from the expand/collapse button provided\n     * and load a new diff fragment representing the state described in that\n     * button. The new diff will represent either an expanded or collapsed\n     * state.\n     *\n     * Args:\n     *     $btn (jQuery):\n     *         The button element that triggered the event leading to this\n     *         function call.\n     */\n    _expandOrCollapse($btn) {\n        this._loadDiff({\n            linesOfContext: $btn.data('lines-of-context'),\n            onDone: this._onExpandOrCollapseFinished.bind(this),\n        });\n    },\n\n    /**\n     * Attempt to hide the controls in the given container after a delay.\n     */\n    _tryShowControlsDelayed() {\n        if (this._collapsible) {\n            _.delay(() => {\n                if (this.$el.is(':hover')) {\n                    this.showControls();\n                }\n            }, this._controlsHoverTimeout);\n        }\n    },\n\n    /**\n     * Attempt to hide the controls in the given container after a delay.\n     */\n    _tryHideControlsDelayed() {\n        if (this._collapsible) {\n            _.delay(() => {\n                if (!this.$el.is(':hover')) {\n                    this.hideControls();\n                }\n            }, this._controlsHoverTimeout);\n        }\n    },\n\n    /*\n     * Handler for when an expanded or collapsed fragment has loaded.\n     *\n     * This will reset the state of the view, based on the new fragment, and\n     * re-render the view.\n     */\n    _onExpandOrCollapseFinished() {\n        RB.setActivityIndicator(false, {});\n\n        /* All our HTML has changed, so clean up and re-render everything. */\n        if (this._centeredMgr !== null) {\n            this._centeredMgr.remove();\n            this._centeredMgr = null;\n        }\n\n        const $collapseButtons = this.$('.diff-collapse-btn');\n\n        /*\n         * Check if we have any collapse buttons. If so, we'll need to track\n         * them in a CenteredElementManager.\n         */\n        if ($collapseButtons.length > 0) {\n            this._centeredMgr = new RB.CenteredElementManager({\n                elements: new Map(Array.prototype.map.call(\n                    $collapseButtons,\n                    el => {\n                        const $chunks = $(el)\n                            .closest('.sidebyside')\n                            .children('tbody')\n                            .not('.diff-header');\n\n                        return [el, {\n                            $top: $chunks.eq(0),\n                            $bottom: $chunks.eq(-1),\n                        }];\n                    }))\n            });\n            this._centeredMgr.updatePosition();\n\n            this._contextExpanded = true;\n        } else {\n            this._contextExpanded = false;\n        }\n\n        this.render();\n\n        if (!this._contextExpanded) {\n            this._tryHideControlsDelayed();\n        }\n    },\n\n    /**\n     * Expand a diff fragment.\n     *\n     * When the expand button is clicked, this will trigger loading of a\n     * new diff fragment containing the context as defined by the data\n     * attributes on the button.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _onExpandButtonClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._expandOrCollapse($(e.target).closest('.diff-expand-btn'), e);\n    },\n\n    /**\n     * Collapse an expanded diff fragment.\n     *\n     * When the collapse button is clicked, this will trigger loading of a\n     * new diff fragment containing the context as defined by the data\n     * attributes on the button.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _onCollapseButtonClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._expandOrCollapse($(e.target).closest('.diff-collapse-btn'), e);\n    },\n});\n"]}