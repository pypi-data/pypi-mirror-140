Metadata-Version: 2.1
Name: c7n-logexporter
Version: 0.4.14
Summary: Cloud Custodian - Cloud Watch Log S3 exporter
Home-page: https://cloudcustodian.io
Author: Cloud Custodian Project
License: Apache-2.0
Platform: UNKNOWN
Classifier: License :: OSI Approved :: Apache Software License
Classifier: Topic :: System :: Systems Administration
Classifier: Topic :: System :: Distributed Computing
Requires-Python: >=3.7,<4.0
Description-Content-Type: text/markdown
Requires-Dist: argcomplete (<3.0.0,>=2.0.0)
Requires-Dist: attrs (<22.0.0,>=21.4.0)
Requires-Dist: boto3 (<2.0.0,>=1.21.5)
Requires-Dist: botocore (<2.0.0,>=1.24.5)
Requires-Dist: c7n (<0.10.0,>=0.9.15)
Requires-Dist: click (<9.0,>=8.0)
Requires-Dist: docutils (<0.18.0,>=0.17.1)
Requires-Dist: importlib-metadata (<5.0.0,>=4.11.1)
Requires-Dist: importlib-resources (<6.0.0,>=5.4.0)
Requires-Dist: jmespath (<0.11.0,>=0.10.0)
Requires-Dist: jsonschema (<5.0.0,>=4.4.0)
Requires-Dist: pyrsistent (<0.19.0,>=0.18.1)
Requires-Dist: python-dateutil (<3.0.0,>=2.8.2)
Requires-Dist: pyyaml (<7.0,>=6.0)
Requires-Dist: s3transfer (<0.6.0,>=0.5.1)
Requires-Dist: six (<2.0.0,>=1.16.0)
Requires-Dist: tabulate (<0.9.0,>=0.8.9)
Requires-Dist: typing-extensions (<5.0.0,>=4.1.1)
Requires-Dist: urllib3 (<2.0.0,>=1.26.8)
Requires-Dist: zipp (<4.0.0,>=3.7.0)

# c7n-log-exporter: Cloud watch log exporter automation

A small serverless app to archive cloud logs across accounts to an archive bucket. It utilizes
cloud log export to s3 feature for historical exports.

It also supports kinesis streams / firehose to move to realtime exports in the same format
as the periodic historical exports.


## Features

 - Log group filtering by regex
 - Incremental support based on previously synced dates
 - Incremental support based on last log group write time
 - Cross account via sts role assume
 - Lambda and CLI support.
 - Day based log segmentation (output keys look
   like $prefix/$account_id/$group/$year/$month/$day/$export_task_uuid/$stream/$log)
 

## Assumptions

 - The archive bucket has already has appropriate bucket policy permissions.
   For details see:
   https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/S3ExportTasks.html#S3Permissions
 - Default periodicity for log group archival into s3 is daily.
 - Exporter is run with account credentials that have access to the archive s3 bucket.
 - Catch up archiving is not run in lambda (do a cli run first)


## Cli usage

```
make install
```

You can run on a single account / log group via the export subcommand
```
c7n-log-exporter export --help
```

## Config format

To ease usage when running across multiple accounts, a config file can be specified, as
an example.

### Using S3 Bucket as destination

```
destination:
  bucket: custodian-log-archive
  prefix: logs2

accounts:
  - name: custodian-demo
    role: "arn:aws:iam::111111111111:role/CloudCustodianRole"
    groups:
      - "/aws/lambda/*"
      - "vpc-flow-logs"
```

### Using CloudWatch Destination as destination cross account
The Cloudwatch Destination needs setup in account and access policy set on CloudWatch Destination to to allow 
source account access to the Cloudwatch Destination

```
subscription:
  destination-arn: "arn:aws:logs:us-east-1:111111111111:destination:CustodianCWLogsDestination"
  destination-role: "arn:aws:iam::111111111111:role/CWLtoKinesisRole"
  name: "CustodianCWLogsDestination"

destination:
  bucket: custodian-log-archive
  prefix: logs2

accounts:
  - name: custodian-demo
    role: "arn:aws:iam::111111111111:role/CloudCustodianRole"
    groups:
      - "/aws/lambda/*"
      - "vpc-flow-logs"
```

## Multiple accounts via cli

To run on the cli across multiple accounts, edit the config.yml to specify multiple
accounts and log groups.

```
c7n-log-exporter run --config config.yml
```

## Serverless Usage

Edit config.yml to specify the accounts, archive bucket, and log groups you want to
use.

```
make install
make deploy
```



