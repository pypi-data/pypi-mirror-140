import{e as _e,k as g,f as G,aK as je,aL as me,l as ee,an as Be,aI as Ee,r as he,o as V,c as te,d as j,F as fe,C as Ge,h as ye,g as L,n as Ve,E as xe,aq as Ke,aM as Oe,aj as We,a as K,p as De,b as He,A as B,aN as ce,aJ as Pe,aH as Je,u as Ue}from"./vendor.e30a69e6.js";import{R as Ye,M as Qe,s as Xe,p as we,a as P,c as Ze,b as et}from"./Radar.497f0088.js";import{_ as $e,A as tt,E as at}from"./index.e1930792.js";const st=M=>(De("data-v-99092c60"),M=M(),He(),M),rt=st(()=>j("svg",{class:"radar__canvas"},[j("g",{class:"radar__edge-container"}),j("g",{class:"radar__ring-container"})],-1)),nt={class:"radar__node-container"},ot={class:"radar__minimap-controls-container"},it={class:"mb-1 d-flex align-center justify-end"},ct={class:"radar__minimap-container"},lt=_e({props:{items:{type:Array,required:!0},id:{type:String,required:!0}},setup(M){const w=M,$=g(w.items),h=g(),T=g(),O=g(),F=g(),ae=g(),J=G(()=>{const t=[...N.value.entries()];return new Map([...u.value.nodes.entries()].filter(([,s])=>t.every(([,i])=>!i.get(s.id))).filter(([,s])=>{var a;if(!u.value.rings.get(s.ring))return;const{position:r}=s;if(!r)return;const n=[...r.nodes.values()];return((a=n==null?void 0:n[0])==null?void 0:a.id)==s.id}))}),ke=G(()=>{const t=new Set([...J.value.entries()].map(([,s])=>s.ring));return new Map([...u.value.rings.entries()].filter(([s])=>t.has(s)))}),se=G(()=>{const t=[...N.value.entries()];return u.value.links.filter(s=>t.every(([,i])=>!i.get(s.target.id))).filter(s=>J.value.get(s.source.id)&&J.value.get(s.target.id))}),Re=({transform:t})=>{var i,r,n;const s=`translate(${t.x}px, ${t.y}px) scale(${t.k})`;(i=F.value)==null||i.style("transform",s),(r=O.value)==null||r.style("transform",s),(n=ae.value)==null||n.style("transform",s),de.value=t},be=t=>{u.value.expandRing(t.ring)},ze=t=>{if(N.value.get(t.id))N.value.delete(t.id);else{const s=u.value.traverse(t);N.value.set(t.id,s)}},Ae=()=>{var i;const t=(r,n,a,v)=>{const _=v*(P/180),e=r+a*Ze(_)||0,l=n+a*et(_)||0;return[e,l]},s=([,r],n=1)=>{const a=r.radius,_=125*360/(2*P*a),e=R.value/2*n,l=k.value/2*n,[o,m]=t(e,l,a,90-_),[b,W]=t(e,l,a,90+_);return`M ${o} ${m} A${r.radius} ${r.radius} 0 1 0 ${b} ${W}`};(i=F.value)==null||i.selectAll(".radar__ring").data(ke.value).join(r=>{const n=r.append("g");return n.attr("id",v=>v.id),n.attr("class","radar__ring").append("path").attr("id",([v])=>v).attr("d",v=>s(v,1)).style("opacity",1).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.03)").attr("stroke-width",80),n},r=>(r.select("path").attr("id",([a])=>a).attr("d",a=>s(a,1)),r),r=>r.remove())},U=()=>{var _;const t=(e,l,o,m,b)=>{const W=Xe(we(o-e,2)+we(m-l,2)),c=b/W,z=(1-c)*e+c*o,A=(1-c)*l+c*m;return[z,A]},s=(e,l)=>{const o=Je(),m=P/2,b=3*P/2,W=0,c=u.value.rings.get(e.source.ring),z=u.value.rings.get(e.target.ring),A=u.value.rings.get(e.target.ring-1),ve=u.value.rings.get(e.source.ring+1),ge=c.links,Ne=ge.findIndex(p=>p.source.id==e.source.id&&p.target.id==e.target.id),y=R.value/2,C=k.value/2,ie=(z.radius-c.radius)/2,Se=ie/ge.length,pe=Ne*Se,Y=e.target.cx,Q=e.target.cy,q=e.target.radian,X=e.source.cx,Z=e.source.cy,I=e.source.radian;let D,H;if(c.radius==0){const[p,x]=t(y,C,Y,Q,z.radius-c.radius);D=p,H=x}else if(e.target.ring-e.source.ring==1){const[p,x]=t(y,C,X,Z,c.radius+ie*1.25-pe);D=p,H=x}else{const[p,x]=t(y,C,X,Z,c.radius+(ve.radius-c.radius)/2);D=p,H=x}if(o.moveTo(X,Z),e.target.ring-e.source.ring>1){c.radius!==0&&(o.lineTo(D,H),o.arc(y,C,c.radius+(ve.radius-c.radius)/2,I,m,I<b&&I>W));const p=A.radius+(z.radius-A.radius)/2,[x,E]=t(y,C,y,p,A.radius+(z.radius-A.radius)/2);o.lineTo(x,E),o.arc(y,C,A.radius+(z.radius-A.radius)/2,m,q,q>b||q<m)}else{o.lineTo(D,H);const[p,x]=t(y,C,Y,Q,z.radius-c.radius);if(Y!==X&&Q!==Z&&c.radius!==0){const E=P/2;o.arc(y,C,c.radius+ie*1.25-pe,I,q,I>E&&q>E&&q<I||I<E&&(q>E||q<I))}else o.moveTo(p,x)}return o.lineTo(Y,Q),o.toString()},i=e=>{const l=u.value.rings.get(e.source.ring),o=u.value.rings.get(e.target.ring),m=l.links,b=(o.radius-l.radius)/m.length;return Math.min(5,b)},r=e=>{const l=d.includes(e.source.id)||d.includes(e.target.id),o=f.value&&(e.source.id==f.value||e.target.id==f.value);return l||o},n=e=>!f.value&&d.length===0||r(e)?1:.2,a=e=>`${e.source.id}---${e.target.id}`,v=e=>{const l=["radar__edge"];return(r(e)||d.length==0&&!f.value)&&l.push(`${e.source.data.state.type.toLowerCase()}-stroke`),se.value.length<100&&l.push("radar__edge--transition"),l.join(" ")};(_=O.value)==null||_.selectAll(".radar__edge").data(se.value).join(e=>e.append("path").attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",n),e=>e.attr("id",a).attr("class",v).style("stroke-width",i).attr("d",s).style("opacity",n),e=>e.remove())},re=()=>{Ae(),U()},le=t=>{f.value==t?f.value=void 0:f.value=t,requestAnimationFrame(()=>U())},ue=t=>{const s=d.indexOf(t);s>-1?d.splice(s,1):d.push(t)},Ce=t=>{requestAnimationFrame(()=>{B(".radar__canvas").transition().duration(200).call(S.value.transform,t)})},qe=({x:t,y:s})=>{S.value.translateBy(B(".radar__canvas"),t,s)},Ie=()=>{d.length=0},ne=()=>{B(".radar__canvas").transition().ease(ce).duration(250).call(S.value.transform,Pe)},Le=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),1.35)})},Me=()=>{requestAnimationFrame(()=>{S.value.scaleBy(B(".radar__canvas").transition().ease(ce).duration(250),.65)})},k=g(0),R=g(0),f=g(),d=je([]),de=g({x:0,y:0,k:1}),N=g(new Map),u=g(new Ye),S=g(me());ee(()=>[w.items,w.id],(t,s)=>{const[i,r]=t,[n,a]=s;$.value=w.items,u.value.items($.value),(i.length>0&&n.length==0||r!==a)&&(u.value.center([R.value/2,k.value/2]),d.length=0,ne()),i.length!==n.length||r!==a?requestAnimationFrame(()=>re()):requestAnimationFrame(()=>U())}),ee(d,()=>{requestAnimationFrame(()=>U())}),ee(se,()=>{requestAnimationFrame(()=>re())});const oe=()=>{!h.value||(k.value=h.value.offsetHeight,R.value=h.value.offsetWidth)},Te=()=>{var t;T.value=B(".radar__canvas"),F.value=T.value.select(".radar__ring-container"),O.value=T.value.select(".radar__edge-container"),ae.value=B(".radar__node-container"),S.value=me().extent([[0,0],[R.value,k.value]]).on("zoom",Re),(t=T.value)==null||t.attr("viewbox",`0, 0, ${R.value}, ${k.value}`).call(S.value),re(),ne()},Fe=t=>{t.preventDefault(),!!h.value&&(h.value.scrollTop=0,h.value.scrollLeft=0)};return Be(()=>{oe(),window.addEventListener("resize",oe),u.value.id("id").dependencies("upstream_dependencies").center([R.value/2,k.value/2]).items($.value),Te()}),Ee(()=>{window.removeEventListener("resize",oe)}),(t,s)=>{const i=he("radar-overflow-node"),r=he("icon-button");return V(),te("div",{ref:(n,a)=>{a.container=n,h.value=n},class:"radar",onScroll:Fe},[rt,j("div",nt,[(V(!0),te(fe,null,Ge(L(J),([n,a])=>{var v,_;return V(),te(fe,{key:n},[((v=a.position)==null?void 0:v.nodes.size)==1?(V(),ye(We(a.data.state.state_details.child_flow_run_id?"radar-flow-run-node":"radar-node"),{key:0,id:`node-${n}`,node:a,selected:L(d).includes(a.id),class:Ve(["radar__node position-absolute",{"radar__node--transparent":L(d).length>0&&!L(d).includes(a.id)&&f.value!==a.id,"radar__node--deemphasized":L(d).length>0&&L(d).some(e=>a.upstreamNodes.get(e)||a.downstreamNodes.get(e))}]),collapsed:N.value.get(n),style:xe({left:`${a.cx}px`,top:`${a.cy}px`}),tabindex:"0",onToggleTree:ze,onClick:Ke(e=>ue(a.id),["stop"]),onKeyup:Oe(e=>ue(a.id),["space","enter"]),onMouseover:e=>le(a.id),onMouseout:e=>le(a.id)},null,8,["id","node","selected","class","collapsed","style","onClick","onKeyup","onMouseover","onMouseout"])):(V(),ye(i,{key:1,class:"position-absolute",nodes:(_=a.position)==null?void 0:_.nodes,style:xe({left:`${a.cx}px`,top:`${a.cy}px`}),tabindex:"0",onClick:e=>be(a)},null,8,["nodes","style","onClick"]))],64)}),128))]),j("div",ot,[j("div",it,[K(r,{class:"bg--white justify-self-start mr-auto",icon:"pi-restart-line",onClick:Ie}),K(r,{class:"bg--white mr-1",icon:"pi-zoom-in-line",onClick:Le}),K(r,{class:"bg--white mr-1",icon:"pi-zoom-out-line",onClick:Me}),K(r,{class:"bg--white",icon:"pi-fullscreen-fill",onClick:ne})]),j("div",ct,[K(Qe,{id:M.id,class:"radar__minimap position-relative",transform:de.value,"collapsed-trees":N.value,radar:u.value,height:k.value,width:R.value,onDragViewport:qe,onPanToLocation:Ce},null,8,["id","transform","collapsed-trees","radar","height","width"])])])],544)}}});var ut=$e(lt,[["__scopeId","data-v-99092c60"]]);const dt={class:"radar z-0"},vt=_e({setup(M){const w=Ue(),$=G(()=>w==null?void 0:w.params.id),h=G(()=>({id:$.value})),T={radar:tt.query({endpoint:at.radar,body:h,options:{pollInterval:5e3}})},O=G(()=>{var F;return((F=T.radar.response)==null?void 0:F.value)||[]});return ee($,()=>{!$.value||T.radar.fetch()}),(F,ae)=>(V(),te("div",dt,[K(ut,{id:L($),items:L(O)},null,8,["id","items"])]))}});var mt=$e(vt,[["__scopeId","data-v-c7dcd594"]]);export{mt as default};
